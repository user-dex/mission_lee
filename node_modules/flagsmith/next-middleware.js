!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["next-middleware"]={})}(this,(function(t){"use strict";var e=function(){return e=Object.assign||function(t){for(var e,a=1,n=arguments.length;a<n;a++)for(var i in e=arguments[a])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},e.apply(this,arguments)};function a(t,e,a){if(a||2===arguments.length)for(var n,i=0,r=e.length;i<r;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))}var n,i,r=function t(e,a){if(e===a)return!0;if(e&&a&&"object"==typeof e&&"object"==typeof a){if(e.constructor!==a.constructor)return!1;var n,i,r;if(Array.isArray(e)){if((n=e.length)!=a.length)return!1;for(i=n;0!=i--;)if(!t(e[i],a[i]))return!1;return!0}if(e.constructor===RegExp)return e.source===a.source&&e.flags===a.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===a.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===a.toString();if((n=(r=Object.keys(e)).length)!==Object.keys(a).length)return!1;for(i=n;0!=i--;)if(!Object.prototype.hasOwnProperty.call(a,r[i]))return!1;for(i=n;0!=i--;){var s=r[i];if(!t(e[s],a[s]))return!1}return!0}return e!=e&&a!=a};!function(t){t.NONE="NONE",t.DEFAULT_FLAGS="DEFAULT_FLAGS",t.CACHE="CACHE",t.SERVER="SERVER"}(n||(n={}));var s,o=null,l="BULLET_TRAIN_DB",g="BULLET_TRAIN_EVENT",c="https://edge.api.flagsmith.com/api/v1/",u=function(t){return"Attempted to "+t+" a user before calling flagsmith.init. Call flagsmith.init first, if you wish to prevent it sending a request for flags, call init with preventFetch:true."},h="flagsmith_value_",d="flagsmith_enabled_",f="flagsmith_trait_",v=function(){function t(t){var a=this;this._trigger=null,this._triggerLoadingState=null,this.timestamp=null,this.isLoading=!1,this.eventSource=null,this.getJSON=function(t,e,n){var r=a,s=r.environmentID,o=r.headers,l={method:e||"GET",body:n,cache:"no-cache",headers:{"x-environment-key":"".concat(s)}};e&&"GET"!==e&&(l.headers["Content-Type"]="application/json; charset=utf-8"),o&&Object.assign(l.headers,o),i||console.error("Flagsmith: fetch is undefined, please specify a fetch implementation into flagsmith.init to support SSR.");var g="".concat(a.identity);return i(t,l).then((function(n){var i,r="".concat(a.identity);if(g===r){var s=null===(i=n.headers)||void 0===i?void 0:i.get("x-flagsmith-document-updated-at");if(s)try{var o=parseFloat(s);if(isNaN(o))throw"Failed to parse x-flagsmith-document-updated-at";a.timestamp=o}catch(t){a.log(t,"Failed to parse x-flagsmith-document-updated-at",s)}return a.log("Fetch response: "+n.status+" "+(e||"GET")+0+t),n.text().then((function(t){var e=t;try{e=JSON.parse(t)}catch(t){}return n.status&&n.status>=200&&n.status<300?e:Promise.reject(e)}))}a.log("Received response with identity miss-match, ignoring response. Requested: ".concat(g,", Current: ").concat(r))})).catch((function(t){throw console.error("Flagsmith: Fetch error: "+t),new Error("Flagsmith: Fetch error:"+t)}))},this._onChange=function(t,e,n){a.setLoadingState(n),a.onChange&&a.onChange(t,e,a.loadingState),a._trigger&&(a.log("trigger called"),a._trigger())},this.getFlags=function(t,i){var s=a;s.onChange;var o=s.onError,l=s.identity,g=s.api,c=!1;a.log("Get Flags"),a.isLoading=!0,a.loadingState.isFetching||a.setLoadingState(e(e({},a.loadingState),{isFetching:!0}));var u=function(t){var i=t.flags,s=t.traits;a.isLoading=!1,l&&(a.withTraits=null);var o={},g={};s=s||[],(i=i||[]).forEach((function(t){o[t.feature.name.toLowerCase().replace(/ /g,"_")]={id:t.feature.id,enabled:t.enabled,value:t.feature_state_value}})),s.forEach((function(t){g[t.trait_key.toLowerCase().replace(/ /g,"_")]=t.trait_value})),a.oldFlags=e({},a.flags);var c=r(a.flags,o),u=r(a.traits,g);if(a.flags=o,a.traits=g,a.updateStorage(),a.datadogRum)try{if(a.datadogRum.trackTraits){var v={};Object.keys(a.traits).map((function(t){v[f+t]=a.getTrait(t)}));var p=e(e(e({},a.datadogRum.client.getUser()),{id:a.datadogRum.client.getUser().id||a.identity}),v);a.log("Setting Datadog user",p),a.datadogRum.client.setUser(p)}}catch(t){console.error(t)}if(a.dtrum)try{var y={javaDouble:{},date:{},shortString:{},javaLongOrObject:{}};Object.keys(a.flags).map((function(t){m(y,h+t,a.getValue(t,{},!0)),m(y,d+t,a.hasFeature(t,!0))})),Object.keys(a.traits).map((function(t){m(y,f+t,a.getTrait(t))})),a.log("Sending javaLongOrObject traits to dynatrace",y.javaLongOrObject),a.log("Sending date traits to dynatrace",y.date),a.log("Sending shortString traits to dynatrace",y.shortString),a.log("Sending javaDouble to dynatrace",y.javaDouble),a.dtrum.sendSessionProperties(y.javaLongOrObject,y.date,y.shortString,y.javaDouble)}catch(t){console.error(t)}a._onChange(a.oldFlags,{isFromServer:!0,flagsChanged:!c,traitsChanged:!u},a._loadedState(null,n.SERVER))};return l?Promise.all([a.withTraits?a.getJSON(g+"identities/","POST",JSON.stringify({identifier:l,traits:Object.keys(a.withTraits).map((function(t){return{trait_key:t,trait_value:a.withTraits[t]}})).filter((function(t){return void 0!==t.trait_value||(a.log("Warning - attempted to set an undefined trait value for key",t.trait_key),!1)}))})):a.getJSON(g+"identities/?identifier="+encodeURIComponent(l))]).then((function(e){a.withTraits=null,u(e[0]),t&&!c&&(c=!0,t())})).catch((function(t){var e=t.message;o&&o(new Error(e))})):Promise.all([a.getJSON(g+"flags/")]).then((function(e){u({flags:e[0],traits:void 0}),t&&!c&&(c=!0,t())})).catch((function(t){i&&!c&&(c=!0,i(t)),o&&o(t)}))},this.analyticsFlags=function(){var t=a.api;if(a.evaluationEvent&&a.evaluationEvent[a.environmentID])return a.evaluationEvent&&0!==Object.getOwnPropertyNames(a.evaluationEvent).length&&0!==Object.getOwnPropertyNames(a.evaluationEvent[a.environmentID]).length?a.getJSON(t+"analytics/flags/","POST",JSON.stringify(a.evaluationEvent[a.environmentID])).then((function(t){var n=a.getState();a.evaluationEvent||(a.evaluationEvent={}),a.evaluationEvent[a.environmentID]={},a.setState(e(e({},n),{evaluationEvent:a.evaluationEvent})),a.updateEventStorage()})).catch((function(t){a.log("Exception fetching evaluationEvent",t)})):void 0},this.datadogRum=null,this.loadingState={isLoading:!0,isFetching:!0,error:null,source:n.NONE},this.canUseStorage=!1,this.analyticsInterval=null,this.api=null,this.cacheFlags=!1,this.ts=null,this.enableAnalytics=!1,this.enableLogs=!1,this.environmentID="",this.evaluationEvent=null,this.flags=null,this.getFlagInterval=null,this.headers=null,this.initialised=!1,this.oldFlags=null,this.onChange=null,this.onError=null,this.identity=null,this.ticks=null,this.timer=null,this.traits=null,this.dtrum=null,this.withTraits=null,this.cacheOptions={ttl:0,skipAPI:!1},this.evaluateFlag=function(t,e){if(a.datadogRum&&(a.datadogRum.client.addFeatureFlagEvaluation?"VALUE"===e?a.datadogRum.client.addFeatureFlagEvaluation(h+t,a.getValue(t,{},!0)):a.datadogRum.client.addFeatureFlagEvaluation(d+t,a.hasFeature(t,!0)):console.error("Flagsmith: Your datadog RUM client does not support the function addFeatureFlagEvaluation, please update it.")),a.enableAnalytics){if(!a.evaluationEvent)return;a.evaluationEvent[a.environmentID]||(a.evaluationEvent[a.environmentID]={}),void 0===a.evaluationEvent[a.environmentID][t]&&(a.evaluationEvent[a.environmentID][t]=0),a.evaluationEvent[a.environmentID][t]+=1}a.updateEventStorage()},this.getValue=function(t,e,n){var i=a.flags&&a.flags[t.toLowerCase().replace(/ /g,"_")],r=null;if(i&&(r=i.value),n||a.evaluateFlag(t,"VALUE"),null===r&&void 0!==(null==e?void 0:e.fallback))return e.fallback;if(null==e?void 0:e.json)try{return null===r?(a.log("Tried to parse null flag as JSON: "+t),null):JSON.parse(r)}catch(t){return e.fallback}return r},this.getTrait=function(t){return a.traits&&a.traits[t.toLowerCase().replace(/ /g,"_")]},this.getAllTraits=function(){return a.traits},this.setTrait=function(t,e){if(a.api){var n={};return n[t]=e,a.setTraits(n)}console.error(u("setTrait"))},this.setTraits=function(t){if(a.api){if(t&&"object"==typeof t||console.error("Expected object for flagsmith.setTraits"),a.withTraits=e(e({},a.withTraits||{}),t),a.identity)return a.initialised?a.getFlags():void 0;a.log("Set traits prior to identifying",a.withTraits)}else console.error(u("setTraits"))},this.hasFeature=function(t,e){var n=a.flags&&a.flags[t.toLowerCase().replace(/ /g,"_")],i=!1;return n&&n.enabled&&(i=!0),e||a.evaluateFlag(t,"ENABLED"),i},i=t.fetch?t.fetch:"undefined"!=typeof fetch?fetch:null===global||void 0===global?void 0:global.fetch,this.canUseStorage="undefined"!=typeof window||!!t.browserlessStorage,this.log("Constructing flagsmith instance "+t),t.eventSource&&(s=t.eventSource),t.AsyncStorage&&(o=t.AsyncStorage)}return t.prototype.init=function(t){var a=this,r=t.environmentID,u=t.api,h=void 0===u?c:u,d=t.headers,f=t.onChange,v=t.cacheFlags,p=t.datadogRum,m=t.onError,y=t.defaultFlags,S=t.fetch,F=t.preventFetch,E=t.enableLogs,O=t.enableDynatrace,b=t.enableAnalytics,I=t.realtime,_=t.eventSourceUrl,L=void 0===_?"https://realtime.flagsmith.com/":_,w=t.AsyncStorage,A=t.identity,T=t.traits,C=t.state,j=t.cacheOptions,D=t.angularHttpClient,k=t._trigger,N=t._triggerLoadingState;return new Promise((function(t,c){var u,_;a.environmentID=r,a.api=h,a.headers=d,a.getFlagInterval=null,a.analyticsInterval=null,a.onChange=f;var P="Wrong Flagsmith Configuration: preventFetch is true and no defaulFlags provided";if(a._trigger=k||a._trigger,a._triggerLoadingState=N||a._triggerLoadingState,a.onError=function(t){a.setLoadingState(e(e({},a.loadingState),{isFetching:!1,isLoading:!1,error:t})),m&&(t instanceof Error?m(t):m(new Error(t)))},a.identity=A,a.withTraits=T,a.enableLogs=E||!1,a.cacheOptions=j?{skipAPI:!!j.skipAPI,ttl:j.ttl||0}:a.cacheOptions,!a.cacheOptions.ttl&&a.cacheOptions.skipAPI&&console.warn("Flagsmith: you have set a cache ttl of 0 and are skipping API calls, this means the API will not be hit unless you clear local storage."),S&&(i=S),a.enableAnalytics=b||!1,a.flags=Object.assign({},y)||{},a.traits=Object.assign({},T)||{},a.initialised=!0,a.ticks=1e4,Object.keys(a.flags).length&&(a.loadingState=e(e({},a.loadingState),{isLoading:!1,source:n.DEFAULT_FLAGS})),I&&"undefined"!=typeof window){var R=L+"sse/environments/"+r+"/stream";s?a.eventSource||(a.log("Creating event source with url "+R),a.eventSource=new s(R),a.eventSource.addEventListener("environment_updated",(function(t){var e;try{e=JSON.parse(t.data).updated_at}catch(t){a.log("Could not parse sse event",t)}e?!a.timestamp||e>a.timestamp?a.isLoading?a.log("updated_at is new, but flags are loading",t.data,a.timestamp):(a.log("updated_at is new, fetching flags",t.data,a.timestamp),a.getFlags()):a.log("updated_at is outdated, skipping get flags",t.data,a.timestamp):a.log("No updated_at received, fetching flags",t)}))):a.log("Error, EventSource is undefined")}if(a.log("Initialising with properties",{environmentID:r,api:h,headers:d,onChange:f,cacheFlags:v,onError:m,defaultFlags:y,preventFetch:F,enableLogs:E,enableAnalytics:b,AsyncStorage:o,identity:A,traits:T,_trigger:k,state:C,angularHttpClient:D},a),a.timer=a.enableLogs?(new Date).valueOf():null,w&&(o=w),a.cacheFlags=void 0!==o&&!!v,a.setState(C),!r)throw c("Please specify a environment id"),"Please specify a environment id";if(p&&(a.datadogRum=p),O&&("undefined"==typeof dtrum?console.error("You have attempted to enable dynatrace but dtrum is undefined, please check you have the Dynatrace RUM JavaScript API installed."):a.dtrum=dtrum),D&&(i=function(t,e){var a=e.headers,n=e.method,i=e.body;return new Promise((function(e){switch(n){case"GET":return D.get(t,{headers:a}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}));case"POST":case"PUT":return D.post(t,i,{headers:a}).subscribe((function(t){e({ok:!0,text:function(){return Promise.resolve(t)}})}))}}))}),o&&a.canUseStorage&&o.getItem(g).then((function(t){if(t)try{a.evaluationEvent=JSON.parse(t)}catch(t){a.evaluationEvent={}}else a.evaluationEvent={};return a.analyticsInterval=setInterval(a.analyticsFlags,a.ticks),!0})),a.enableAnalytics&&(a.analyticsInterval&&clearInterval(a.analyticsInterval),o&&a.canUseStorage&&o.getItem(g,(function(t,n){if(n){var i=JSON.parse(n);i[a.environmentID]&&(C=a.getState(),a.log("Retrieved events from cache",n),a.setState(e(e({},C),{evaluationEvent:i[a.environmentID]})))}return!0}))),v){if(o&&a.canUseStorage){var U=function(e,i){var r,s;if(i)try{var o=JSON.parse(i),l=!1;if(o&&o.api===a.api&&o.environmentID===a.environmentID){var g=!0;a.identity&&o.identity!==a.identity&&(a.log("Ignoring cache,  identity has changed from "+o.identity+" to "+a.identity),g=!1),a.cacheOptions.ttl&&(!o.ts||(new Date).valueOf()-o.ts>a.cacheOptions.ttl)&&o.ts&&(a.log("Ignoring cache, timestamp is too old ts:"+o.ts+" ttl: "+a.cacheOptions.ttl+" time elapsed since cache: "+((new Date).valueOf()-o.ts)+"ms"),g=!1),g&&(l=!0,a.setState(o),a.log("Retrieved flags from cache",o))}if(l){var u=!(F||a.cacheOptions.skipAPI&&l);a._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!a.traits&&!!Object.keys(a.traits).length},a._loadedState(null,n.CACHE,u)),a.oldFlags=a.flags,t(!0),a.cacheOptions.skipAPI&&l&&a.log("Skipping API, using cache"),u&&a.getFlags()}else F?t(!0):a.getFlags(t,c)}catch(t){a.log("Exception fetching cached logs",t)}else F?(y?a._onChange(null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!a.traits&&!!Object.keys(a.traits).length},a._loadedState(null,n.DEFAULT_FLAGS)):a.flags?null===(r=a._onChange)||void 0===r||r.call(a,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!a.traits&&!!Object.keys(a.traits).length},a._loadedState(null,n.DEFAULT_FLAGS)):null===(s=a.onError)||void 0===s||s.call(a,new Error(P)),t(!0)):a.getFlags(t,c);return!0};if(o.getItemSync)try{U(0,o.getItemSync(l))}catch(t){}else o.getItem(l,U)}}else if(F){if(y)null===(u=a._onChange)||void 0===u||u.call(a,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!a.traits&&!!Object.keys(a.traits).length},a._loadedState(null,n.DEFAULT_FLAGS));else if(a.flags){var J=null;0===Object.keys(a.flags).length&&(J=P),null===(_=a._onChange)||void 0===_||_.call(a,null,{isFromServer:!1,flagsChanged:!0,traitsChanged:!!a.traits&&!!Object.keys(a.traits).length},a._loadedState(J,n.DEFAULT_FLAGS))}t(!0)}else a.getFlags(t,c)})).catch((function(t){a.log("Error during initialisation ",t),m&&m(t)}))},t.prototype._loadedState=function(t,e,a){return void 0===t&&(t=null),void 0===a&&(a=!1),{error:t,isFetching:a,isLoading:!1,source:e}},t.prototype.getAllFlags=function(){return this.flags},t.prototype.identify=function(t,a){return this.identity=t,this.log("Identify: "+this.identity),a&&(this.withTraits=e(e({},this.withTraits||{}),a)),this.initialised?this.getFlags():Promise.resolve()},t.prototype.getState=function(){return{api:this.api,environmentID:this.environmentID,flags:this.flags,identity:this.identity,ts:this.ts,traits:this.traits,evaluationEvent:this.evaluationEvent}},t.prototype.setState=function(t){t&&(this.initialised=!0,this.api=t.api||this.api||c,this.environmentID=t.environmentID||this.environmentID,this.flags=t.flags||this.flags,this.identity=t.identity||this.identity,this.traits=t.traits||this.traits,this.withTraits=e(e({},this.withTraits||{}),this.traits),this.evaluationEvent=t.evaluationEvent||this.evaluationEvent,this.log("setState called",this))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enableLogs&&console.log.apply(this,a(["FLAGSMITH:",(new Date).valueOf()-(this.timer||0),"ms"],t,!0))},t.prototype.updateStorage=function(){if(this.cacheFlags){this.ts=(new Date).valueOf();var t=JSON.stringify(this.getState());this.log("Setting storage",t),o.setItem(l,t)}},t.prototype.updateEventStorage=function(){if(this.enableAnalytics){var t=JSON.stringify(this.getState().evaluationEvent);o.setItem(g,t)}},t.prototype.setLoadingState=function(t){var a;r(t,this.loadingState)||(this.loadingState=e({},t),this.log("Loading state changed",t),null===(a=this._triggerLoadingState)||void 0===a||a.call(this))},t.prototype.logout=function(){return this.identity=null,this.traits={},this.initialised?this.getFlags():Promise.resolve()},t.prototype.startListening=function(t){void 0===t&&(t=1e3),this.getFlagInterval&&clearInterval(this.getFlagInterval),this.getFlagInterval=setInterval(this.getFlags,t)},t.prototype.stopListening=function(){this.getFlagInterval&&(clearInterval(this.getFlagInterval),this.getFlagInterval=null)},t.prototype.getSegments=function(){},t}();function p(t){var e=t.fetch,a=t.AsyncStorage,n=t.eventSource;return new v({fetch:e,AsyncStorage:a,eventSource:n})}var m=function(t,e,a){var n="shortString",i=!0;"number"==typeof a&&(n="javaDouble",i=!1),t[n]=t[n]||{},t[n][e]=i?a+"":a},y=p({});t.createFlagsmithInstance=function(){return p({})},t.default=y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=next-middleware.js.map
